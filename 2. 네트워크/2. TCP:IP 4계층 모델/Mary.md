# TCP/IP 4계층 모델

- 인터넷 프로토콜 스위트(internet protocol suite)
    - 인터넷에서 컴퓨터들이 서로 정보를 주고받는 데 쓰이는 프로토콜의 집합
    - 이를 TCP/IP 4계층 모델 또는 OSI 7계층 모델로 설명하기도 함

- 네트워크에서 사용되는 통신 프로토콜의 집합
- 프로토콜의 네트워킹 범위에 따라 네 개의 추상화 계층으로 구성

## 계층 구조

- 특정 계층이 변경되었을 때 다른 계층이 영향을 받지 않도록 설계됨
- 애플리케이션 계층, 전송 계층, 인터넷 계층, 링크 계층

### 애플리케이션(application) 계층

- FTP, HTTP, SSH, SMTP, DNS 등 응용 프로그램이 사용되는 프로토콜 계층이며 웹서비스, 이메일 등 **서비스를** 실질적으로 **사람들에게 제공**하는 계층
    - FTP: 장치와 장치 간의 파일을 **전송**하는 데 사용되는 표준 **통신 프로토콜**
    - HTTP: World Wide Web을 위한 데이터 통신의 기초이자 **웹 사이트**를 이용하는 데 쓰는 **프로토콜**
    - SSH: 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 **암호화 네트워크 프로토콜**
    - SMTP: **전자 메일 전송**을 위한 인터넷 표준 **통신 프로토콜**
    - DNS: 도메인 이름과 IP 주소를 매핑해주는 서버 (이를 통해 IP주소가 바뀌어도 사용자들에게 똑같은 도메인 주소로 서비스할 수 있음)

### 전송(transport) 계층

- 송신자와 수신자를 연결하는 **통신 서비스 제공**
- 연결 지향 데이터 스트림 지원
- 신뢰성, 흐름 제어 제공
- 애플리케이션과 인터넷 계층 사이의 데이터가 전달될 때 중계 역할
- 대표적으로 TCP와 UDP가 있음
    - TCP
        - 패킷 사이의 **순서를 보장**
        - 연결지향 프로토콜을 사용해서 연결을 하여 신뢰성을 구축해서 **수신 여부를 확인**
        - `가상회선 패킷 교환 방식`을 사용
    - UDP
        - 패킷 사이의 **순서를 보장하지 않음**
        - **수신여부를 확인하지 않음**
        - `데이터그램 패킷 교환 방식`을 사용
- 패킷 교환 방식
    - 가상회선 패킷 교환 방식
        - 각 패킷에는 가상회선 식별자가 포함되며 모든 패킷을 전송하면 가상 회선이 해제되고 패킷들은 전송된 **순서대로** 도착하는 방식
    - 데이터그램 패킷 교환 방식
        - 패킷이 독립적으로 이동하며 최적의 경로를 선택하여 가는데, 하나의 메시지에서 분할된 여러 패킷은 서로 다른 경로로 전송될 수 있으며 **도착한 순서가 다를 수 있는** 방식
- TCP 연결 성립 과정
    - TCP는 신뢰성을 확보할 때 3-way handshake 작업을 진행
        1. SYN 단계: 클라이언트 → 서버로 클라이언트의 ISN을 담아 SYN을 보냄
            1. ISN: 새로운 TCP 연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호, 장치마다 다를 수 있음
        2. SYN+ACK 단계: 서버 → 클라이언트로 서버의 ISN과 승인 번호를 담아 보냄
            1. 승인 번호: 클라이언트의 ISN + 1
        3. ACK 단계: 클라이언트 → 서버로 승인번호를 담아 보냄
            1. 승인 번호: 서버의 ISN + 1
        
        > SYN: synchronization의 약자. 연결 요청 플래그.
        > 
        > 
        > ACK: acknowledgement의 약자. 응답 플래그.
        > 
        > ISN: Initial Sequence Numbers의 약어. 초기 네트워크 연결을 할 때 할당된 32비트 고유 시퀀스 번호.
        > 
- TCP 연결 해제 과정
    - TCP는 연결을 해제할 때 4-way handshake 작업을 진행
        1. 클라이언트 → 서버로 FIN으로 설정된 세그먼트를 보내고, 클라이언트는 FIN_WAIT_1 상태로 들어가서 서버의 응답을 기다림
        2. 서버 → 클라이언트로 ACK라는 승인 세그먼트를 보내고, 서버는 CLOSE_WAIT 상태로 들어감. 만약 클라이언트가 세그먼트를 받으면 FIN_WAIT_2 상태로 들어감.
        3. 일정 시간 이후에 서버 → 클라이언트로 FIN이라는 세그먼트를 보냄
        4. FIN 세그먼트를 받은 클라이언트는 TIME_WAIT 상태가 되고 다시 서버로 ACK를 보냄. 서버는 CLOSED 상태로 변함. 이후 클라이언트는 어느 정도의 시간을 대기한 후 연결이 닫히고 클라이언트와 서버의 모든 자원의 연결이 해제됨.
    - TIME_WAIT 상태는 왜 있을까?
        - 지연 패킷이 발생할 경우를 대비하기 위함. 패킷이 뒤늦게 도달하고 이를 처리하지 못한다면 데이터 무결성 문제가 발생
        - 두 장치가 연결이 닫혔는지 확인하기 위함. LASK_ACK 상태에서 닫히게 되면 다시 새로운 연결을 하려고 할 때 장치는 LAST_ACK로 되어 있기 때문에 접속 오류가 나타나게 됨
        
        > TIME_WAIT: 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태. 지연 패킷 등의 문제점을 해결하는데 쓰임. CentOS6, 우분투에는 60초로 설정되어 있으며 윈도우는 4분으로, OS마다 조금씩 다르다.
        > 
        > 
        > 데이터 무결성(data integrity): 데이터의 정확성과 일관성을 유지하고 보증하는 것
        > 

### 인터넷(internet) 계층

- 장치로부터 받은 **네트워크 패킷을** IP주소로 지정된 **목적지로 전송하기 위해 사용되는 계층**
- IP, ARP, ICMP 등이 있으며 패킷을 수신해야 할 상대의 주소를 지정하여 데이터를 전달
- 상대방이 제대로 받았는지에 대해 보장하지 않는 비연결형적인 특징을 가지고 있음

### 링크(link) 계층

- 전선, 광섬유, 무선 등으로 실질적으로 데이터를 전달하며 장치 간에 신호를 주고받는 규칙을 정하는 계층
- 네트워크 접근 계층이라고도 함
- 물리 계층과 데이터 링크 계층으로 나누기도 하는데, 물리 계층은 무선 LAN과 유선 LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층을 말하며, 데이터 링크 계층은 `[이더넷 프레임](https://www.notion.so/TCP-IP-4-16ecb698f4834b60a2b83eeb4e1ee909?pvs=21)`을 통해 에러 확인, 흐름 제어, 접근 제어를 담당하는 계층을 말합니다.
- 유선 LAN(IEEE802.3)
    - 유선 LAN을 이루는 이더넷은 IEEE802.3이라는 프로토콜을 따르며 전이중화 통신을 사용
        - 전이중화(full duplex) 통신?
            - 양쪽 장치가 동시에 송수신할 수 있는 방식
            - 송신로와 수신로로 나눠서 데이터를 주고받으며 현대의 고속 이더넷은 이 방식을 기반으로 통신
        - CSMA/CD(Carrier Sense Multiple Access with Collision Detection)
            - 반이중화 통신 중 하나
            - 데이터를 보낸 이후 충돌이 발생한다면 일정 시간 이후 재전송하는 방식
- 유선 LAN을 이루는 케이블
    - TP(Twisted Pair) 케이블과 광섬유 케이블이 대표적
        - Twisted pair cable
            - 하나의 케이블처럼 보이지만 실제로는 여덟 개의 구리선을 두 개씩 꼬아서 묶은 케이블을 지칭
            - 구리선을 실드 처리하지 않고 덮으면 UTP 케이블 (=LAN 케이블)
            - 실드 처리하고 덮으면 STP 케이블
        - 광섬유 케이블
            - 레이저를 이용해서 통신하기 때문에 구리선과는 비교할 수 없을 만큼의 장거리 및 고속 통신(보통 100Gbps)이 가능
            - 광섬유 내부와 외부를 다른 밀도를 가지는 유리나 플라스틱 섬유로 제작해서 한 번 들어간 빛이 내부에서 계속적으로 반사하며 전진하여 반대편 끝까지 가는 원리를 이용한 것
- 무선 LAN(IEEE802.11)
    - 수신과 송신에 같은 채널을 사용하는 반이중화 통신을 사용
        - 반이중화(half duplex) 통신?
            - 양쪽 장치는 서로 통신할 수 있지만, 동시에는 통신할 수 없으며 한 번에 한 방향만 통신 가능
            - 일반적으로 장치가 신호를 수신하기 시작하면 응답하기 전에 전송이 완료될 때까지 기다려야 함
            - 둘 이상의 장치가 동시에 전송하면 충돌이 발생하여 메시지가 손실되거나 왜곡될 수 있기 때문에 충돌 방지 시스템이 필요
        - CSMA/CA(Carrier Sense Multiple Access with Collision Avoidance)
            - 반이중화 통신 중 하나
            - 데이터를 보내기 전에 다음 과정을 기반으로 사전에 가능한 한 충돌을 방지하는 방식
                1. 사용 중인 채널이 있다면 다른 채널을 감지하다 유휴 상태인 채널을 발견
                2. 프레임 간 공간 시간인 IFS(Inter Frame Space) 시간만큼 기다림 (IFS시간을 조정함으로써 프레임의 우선순위를 정하기도 함)
                3. 0~2^k-1 사이의 랜덤 상수만큼 기다린 뒤 프레임을 보냄. 프레임을 보낸 뒤 제대로 송신이 되었고 ACK 세그먼트를 받았다면 마침. 하지만 받지 못했다면 k = k+1을 하며 이 과정을 반복. 반복하다가 k가 정해진 값보다 더 커진다면 해당 프레임 전송은 버림
- 무선 LAN을 이루는 주파수
    - 무선 LAN(WLAN, Wireless Local Area Network)은 무선 신호 전달 방식을 이용하여 2대 이상의 장치를 연결하는 기술
    - 주파수 대역은 2.4GHz 대역 또는 5GHz 중 하나를 사용
    - 2.4GHz는 장애물에 강하지만 전파 간섭이 일어나는 경우가 많고 5GHz는 사용할 수 있는 채널 수도 많고 동시에 사용할 수 있기 때문에 상대적으로 깨끗한 전파환경을 구축할 수 있음
    - 와이파이(wifi)
        - 전자기기들이 무선 LAN신호에 연결할 수 있게 하는 기술
        - 사용하려면 무선 접속 장치(AP, Access Point)가 있어야 함 (=공유기)
        - 유선 LAN에 흐르는 신호를 무선 LAN 신호로 바꿔주어 신호가 닿는 범위 내에서 무선 인터넷을 사용할 수 있음
    - BSS(Basic Service Set)
        - 단순 공유기를 통해 네트워크에 접속하는 것이 아닌 동일 BSS내에 있는 AP들과 장치들이 서로 통신이 가능한 구조
        - 근거리 무선 통신을 제공하고, 하나의 AP만을 기반으로 구축이 되어 있어 사용자가 한 곳에서 다른 곳으로 자유롭게 이동하며 네트워크에 접속하는 것은 불가능
    - ESS(Extended Service Set)
        - 하나 이상의 연결된 BSS 그룹
        - 장거리 무선 통신을 제공하며 BSS보다 더 많은 가용성과 이동성을 지원
        - 즉, 사용자는 한 장소에서 다른 장소로 이동하며 중단 없이 네트워크에 계속 연결할 수 있음
- 이더넷 프레임: 이더넷 기반의 네트워크에서 데이터를 전송할 때 사용되는 기본 단위
    - Preamble: 이더넷 프레임이 시작임을 알림. 동기화를 위함
    - SFD(Start Frame Delimiter): 다음 바이트부터 MAC 주소 필드가 시작됨을 알림
    - DMAC, SMAC: 수신, 송신 MAC 주소
    - EtherType: 데이터 계층 위의 계층인 IP 프로토콜을 정의 (ex. IPv4, IPv6)
    - Payload: 전달받은 데이터
    - FCS(Frame Check Sequence): 에러 확인 비트 (= CRC)
    
    > MAC 주소: 컴퓨터나 노트북 등 각 장치에는 네트워크에 연결하기 위한 장치(LAN카드)가 있는데, 이를 구별하기 위한 식별번호를 말한다. 6바이트(48비트)로 구성된다.
    > 

### 계층 간 데이터 송수신 과정

- 애플리케이션 계층에서 전송계층으로 요청값들이 캡슐화 과정을 거쳐 전달되고, 다시 링크 계층을 통해 해당 서버와 통신을 하고, 해당 서버의 링크 계층으로부터 애플리케이션까지 비캡슐화 과정을 거쳐 데이터가 전송됨
- 캡슐화 과정
    - 상위 계층의 헤더와 데이터를 하위 계층의 데이터 부분에 포함시키고 해당 계층의 헤더를 삽입하는 과정

    - 애플리케이션 계층 - 데이터
    전송 계층 - 세그먼트, 데이터그램화
    인터넷 계층 - 패킷화
    링크 계층 - 프레임화
- 비캡슐화 과정
    - 하위 계층에서 상위 계층으로 가며 각 계층의 헤더 부분을 제거하는 과정

## PDU(Protocol Data Unit)

- 네트워크의 어떠한 계층에서 계층으로 데이터가 전달될 때 한 덩어리의 단위
- 제어 관련 정보들이 포함된 헤더와 데이터를 의미하는 페이로드로 구성
    - 애플리케이션 계층: 메시지
    - 전송 계층: 세그먼트(TCP), 데이터그램(UDP)
    - 인터넷 계층: 패킷
    - 링크 계층: 프레임(데이터 링크 계층), 비트(물리 계층)
