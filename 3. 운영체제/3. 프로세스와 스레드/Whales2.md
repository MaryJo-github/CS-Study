# Section 3.3 프로세스와 스레드(2)
## 3.3.5 멀티프로세싱

- 여러 개의 ‘프로세스’ → 동시에 두 가지 이상의 일 수행 가능
- 하나 이상의 일을 병렬로 처리할 수 있으며 일부에 문제가 발생되더라도 다른 프로세스를 이용하여 처리 가능
- 신뢰성 높다.

### 웹 브라우저

- 브라우저 프로세스
    - 네트워크 요청이나 파일 접근 같은 권한을 담당
    - 주소표시줄, 북마크 막대, 뒤로가기/앞으로가기 버튼 등
- 렌더러 프로세스
    - 웹 사이트가 `보이는` 모든 것을 제어
- 플러그인 프로세스
    - 웹 사이트에서 사용하는 플러그인을 제어
- GPU 프로세스
    - GPU를 이용해서 화면을 그리는 부분을 제어

### IPC(Inter Process Communication)

- 프로세스끼리 데이터를 주고받고, 공유 데이터를 관리하는 메커니즘
→ 멀티프로세스는 IPC가 가능
- Ex. 클라이언트 → 서버 데이터 요청, 서버 → 클라이언트 요청에 응답
- 메모리가 완전히 공유되는 스레드보다는 속도가 떨어진다.
- 종류 : 공유 메모리, 파일, 소켓 , 익명 파이프, 명명 파이프, 메시지 큐

**공유 메모리(shared memory)**

- 여러 프로세스에 동일한 메모리 블록에 대한 접근 권한이 부여되어 
프로세스가 서로 통신할 수 있도록 공유 버퍼를 생성하는 것
- 공유 메모리를 통해 여러 프로세스가 하나의 메모리를 공유할 수 있다.
- 불필요한 데이터 복사의 오버헤드가 발생하지 않음 → 가장 빠르다.
- 같은 메모리 영역을 여러 프로세스가 공유 → 동기화가 필요하다.

**파일**

- 디스크에 저장된 데이터 또는 파일 서버에서 제공한 데이터
- 파일을 기반으로 프로세스 간 통신을 한다.

**소켓**

- 동일한 컴퓨터의 다른 프로세스나 네트워크의 다른 컴퓨터로 네트워크 인터페이스를 통해 전송하는 데이터
- TCP, UDP

**익명 파이프(unnamed pipe)**

- 프로세스 간에 FIFO 방식으로 읽히는 임시 공간인 파이프를 기반으로 데이터를 주고 받는다.
- 단방향 방식의 읽기 전용, 쓰기 전용 파이프를 만들어서 작동하는 방식
- 부모, 자식 프로세스 간에만 사용 가능. 다른 네트워크 불가능

**명명 파이프(named pipe)**

- 파이프 서버와 하나 이상의 파이프 클라이언트 간의 통신을 위한 명명된 단방향 또는 이중 파이프
- 클라이언트/서버 통신을 위한 별도의 파이프를 제공
- 여러 파이프 동시 사용 가능
- 컴퓨터의 프로세스끼리 또는 다른 네트워크 상의 컴퓨터와도 통신 가능


**메시지 큐**

- 메시지를 큐(queue) 데이터 구조 형태로 관리하는 것
- 커널의 전역변수 형태 등 커널에서 전역적으로 관리된다.
- 다른 IPC 방식에 비해 사용 방법이 매우 직관적이고 간단.
- 다른 코드의 수정 없이 몇 줄의 코드를 추가시켜 간단하게 메시지 큐에 접근 가능
- 공유 메모리를 통해 IPC를 구현할 때 빈도가 높으면 동기화 때문에 기능을 구현하는 것이 복잡
→ 이때 대안으로 메시지 큐 사용

## 3.3.6 스레드와 멀티스레딩

### 스레드(Thread)

- 프로세스의 실행 가능한 가장 작은 단위. 프로세스는 여러 스레드를 가질 수 있다.
- 코드, 데이터, 스택, 힙을 스레드끼리 서로 공유(프로세스는 각각 생성)
- 그 외의 영역은 각각 생성

### 멀티스레딩

- 프로세스 내 작업을 여러 개의 스레드로 처리하는 기법
- 스레드끼리 서로 자원을 공유하기 때문에 효율성이 높다.
- 새 프로세스를 생성하는 대신 스레드를 사용하는 경우 훨씬 적은 리소스를 소비.
- 한 스레드가 중단(blocked)되어도 다른 스레드는 실행(running) 상태 일 수 있기 때문에 중단되지 않은 빠른 처리 가능
- 동시성(서로 독립적인 작업들을 작은 단위로 나누고 동시에 실행되는 것처럼 보여주는 것)
- 한 스레드에 문제가 생기면 다른 스레드에도 영향을 끼쳐 스레드로 이루어져 있는 프로세스에 영향을 줄 수 있는 단점이 있다.
- ex. 렌더러 프로세스(메인 스레드, 워커 스레드, 컴포지터 스레드, 레스터 스레드가 존재)


## 3.3.7 공유 자원과 임계 영역

### 공유 자원(shared resource)

- 시스템 안에서 각 프로세스, 스레드가 함께 접근할 수 있는 모니터, 프린터, 메모리, 파일, 데이터 등의 자원이나 변수
- 이 공유 자원을 두 개 이상의 프로세스가 동시에 읽거나 쓰는 상황을 `경쟁상태(race condition)`이라 한다.
→ 동시에 접근을 시도할 때 접근의 타이밍이나 순서 등이 결괏값에 영향을 줄 수 있는 상태
- ex. 프로세스 A와 프로세스 B가 동시에 접근하여 타이밍이 꼬여 200이 출력

### 임계 영역(critical section)

- 둘 이상의 프로세스, 스레드가 공유 자원에 접근할 때 순서 등의 이유로 결과가 달라지는 코드 영역
- 해결 방법 - 뮤텍스, 세마포어, 모니터
    - 상호 배제(한 프로세스가 임계 영역에 들어 갔을 때 다른 프로세스는 들어갈 수 없음),
    한정 대기(특정 프로세스가 영원히 임계 영역에 들어가지 못하면 안된다.),
    융통성 만족(한 프로스세스가 다른 프로세스의 일을 방해해서는 안된다.)
    - 메커니즘: 잠금(Lock) (임계 영역을 화장실이라고 하면 사람이 들어가면 잠그고 나오면 그 다음 사람)

**뮤텍스(mutex)**

- 프로세스나 스레드가 공유 자원을 `lock()`을 통해 잠금 설정, `unlock()`을 통해 잠금 해제하는 객체
- 잠금 메커니즘
- 잠금 상태 → 다른 프로세스나 스레드 접근 불가
- 잠금 또는 잠금 해제 라는 상태만을 가진다.

**세마포어(semaphore)**

- 일반화된 뮤텍스
- 간단한 정수 값과 두 가지 함수 wait(P 함수) 및 signal(V 함수)로 공유 자원에 대한 접근 처리
- `wait()` 자신의 차례가 올 때까지 기다리는 함수
`signal()` 다음 프로세스로 순서를 넘겨주는 함수
- 조건 변수가 없다.
- 상호 배제를 명시적으로 구현해야 한다.
- 신호 메커니즘
- 프로세스나 스레드가 세마포어 값을 수정할 때 다른 프로세스나 스레드는 동시에 세마포어 값을 수정할 수 없다.
- 바이너리 세마포어
    - 0과 1 두 가지 값만 가질 수 있는 세마포어
- 카운팅 세마포어
    - 여러 개의 값을 가질 수 있는 세마포어
    - 여러 자원에 대한 접근을 제어하는 데 사용

**모니터**

- 둘 이상의 스레드나 프로세스가 공유 자원에 안전하게 접근할 수 있도록 공유 자원을 숨기고 해당 접근에 대해 인터페이스만 제공
- 모니터큐를 통해 공유 자원에 대한 작업들을 순차적으로 처리
- 세마포어보다 구현 쉬우며 상호 배제가 자동


## 3.3.8 교착 상태(deadlock)

- 두 개 이상의 프로세스들이 서로가 가진 자원을 기다리며 중단된 상태
- 프로세스 A가 프로세스 B의 어떤 자원을 요청할 때 프로세스 B도 프로세스 A의 자원을 요청

### 원인

- 상호 배제: 한 프로세스가 자원을 독점하고 있으며 다른 프로세스들은 접근 불가
- 점유 대기: 특정 프로세스가 점유한 자원을 다른 프로세스가 요청
- 비선점: 다른 프로세스의 자원을 강제적으로 가져올 수 없다
- 환형 대기: 서로가 서로의 자원을 요구

### 해결 방법

1. 자원을 할당할 때 애초에 조건이 성립되지 않도록 설계
2. 교착 상태 가능성이 없을 때만 자원 할당, 프로세스당 요청할 자원들의 최대치를 통해 자원 할당 가능 여부를 파악하는 `은행원 알고리즘` 사용
3. 교착 상태가 발생하면 사이클이 있는지 찾아보고 이에 관련된 프로세스를 한 개씩 삭제
4. 교착 상태는 매우 드물게 일어나기 때문에 이를 처리하는 비용이 더 커서 교착 상태가 발생하면 사용자가 작업을 종료. → 현대 운영체제 채택.
ex. 프로세스 실행시키다 ‘응답 없음’이라고 뜰 때.

<aside>
💡 은행원 알고리즘: 총 자원의 양과 현재 할당한 자원의 양을 기준으로 안정 또는 불안정 상태로 나누고 안정 상태로 가도록 자원을 할당하는 알고리즘

</aside>
