# 인덱스

## 📍인덱스의 필요성
- 인덱스는 데이터를 빠르게 찾을 수 있는 하나의 장치
- 인덱스는 보통 B-트리라는 자료 구조로 이루어져 있음

<br>

## 📍B-트리
- 데이터 베이스와 파일 시스템에서 널리 사용되는 트리 자료구조의 일종
- 이진 트리를 확장해 하나의 노드가 가질 수 있는 자식 노드의 최대 숫자가 2보다 큰 트리구조
- 루트 노드, 브랜치 노드, 리프 노드로 구성됨
- 특징
    1. 노드에는 2개 이상의 데이터(key)가 들어갈 수 있으며, 항상 정렬된 상태로 저장된다.
    2. 내부 노드는 ceil(M/2) ~ M개의 자식을 가질 수 있다. 최대 M개의 자식을 가질 수 있는 B 트리를 M차 B트리라고 한다.
    3. 특정 노드의 데이터(key)가 K개라면, 자식 노드의 개수는 K+1개여야 한다.
    4. 특정 노드의 왼쪽 서브 트리는 특정 노드의 key보다 작은 값들로, 오른쪽 서브 트리는 큰 값들로 구성된다.
    5. 노드 내에 데이터는 ceil(M/2)-1개부터 최대 M-1개까지 포함될 수 있다.
    6. 모든 리프 노드들이 같은 레벨에 존재한다.
    - 참고: https://code-lab1.tistory.com/217#google_vignette

### 인덱스가 효율적인 이유와 대수확장성
- 인덱스가 효율적인 이유
    - 효율적인 단계를 거쳐 모든 요소에 접근할 수 있는 `균형 잡힌 트리 구조`와 `트리 깊이의 대수확장성` 때문
- 대수확장성
    - 트리 깊이가 리프 노드 수에 비해 매우 느리게 성장하는 것을 의미
    - 기본적으로 인덱스가 한 깊이씩 증가할 때마다 최대 인덱스 항목의 수는 4배씩 증가함

<br>

## 📍인덱스 만드는 방법
데이터베이스마다 다르며 MySQL과 MongoDB 기준으로 설명

### MySQL
- 클러스터형 인덱스
    - 테이블당 하나 설정할 수 있음
    - 하나의 인덱스만 생성할 것이라면 클러스터형 인덱스를 만드는 것이 좋음
    - 생성하는 방법
        - primary key 옵션으로 기본키 만들기
        - 기본키로 만들지 않고 unique not null 옵션 붙이기
- 세컨더리 인덱스
    - 보조 인덱스로 여러 개의 필드 값을 기반으로 쿼리를 많이 보낼 때 생성해야하는 인덱스
    - 생성하는 방법
        - create index 명령어를 기반으로 생성

### MongoDB
- 도큐먼트를 만들면 자동으로 ObjectID가 형성되며, 해당 키가 기본키로 설정됨
- 세컨더리키도 부가적으로 설정하여 기본키와 세컨더리키를 같이 쓰는 복합 인덱스를 설정할 수 있음

<br>

## 📍인덱스 최적화 기법
이 책에서는 MongoDB 기반으로 기법을 설명함

### 1. 인덱스는 비용이다
- 인덱스는 두 번 탐색하도록 강요합니다. 인덱스 리스트, 그 다음 컬렉션 순으로 탐색하기 때문이며, 관련 읽기 비용이 들게 됨
- 컬렉션이 수정되었을 때 인덱스도 수정되어야함.
    - 이때 B-트리의 높이를 균형있게 조절하는 비용도 들고, 데이터를 효율적으로 조회할 수 있도록 분산시키는 비용도 들게됨
- 그렇기 때문에 쿼리에 있는 필드에 인덱스를 무작정 다 설정하는 것은 답이 아님. 또한 컬렉션에서 가져와야 하는 양이 많을수록 인덱스를 사용하는 것은 비효율적

### 2. 항상 테스팅하라
- 인덱스 최적화 기법은 서비스 특징에 따라 달라짐. 서비스에서 사용하는 객체의 깊이, 테이블의 양 등이 다르기 때문. 따라서 항상 테스팅하는 것이 중요함
- explain() 함수를 통해 인덱스를 만들고 쿼리를 보낸 이후에 테스팅을 하며 걸리는 시간을 최소화 해야함

### 3. 복합 인덱스는 같음, 정렬, 다중 값, 카디널리티 순이다.
보통 여러 필드를 기반으로 조회할 때 복합 인덱스를 생성하는데, 이 인덱스를 생성할 때는 순서가 있고 생성 순서에 따라 인덱스 성능이 달라짐.
1. 어떠한 값과 `같음`을 비교하는 ==이나 equal이라는 쿼리가 있다면 제일 먼저 인덱스로 설정
2. `정렬`에 쓰는 필드라면 그 다음 인덱스로 설정
3. `다중 값`을 출력해야 하는 필드, 즉 쿼리 자체가 />이거나 /< 등 많은 값을 출력해야 하는 쿼리에 쓰는 필드라면 나중에 인덱스를 설정
4. 유니크한 값의 정도를 `카디널리티`라고 하는데, 이 카디널리티가 높은 순서를 기반으로 인덱스를 생성해야함.
